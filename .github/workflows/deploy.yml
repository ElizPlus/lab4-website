name: Deploy to GitHub Pages

on:
  push:
    tags: ['v*']
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Build site with version history
      run: |
        # Создаем основную папку
        mkdir -p _site
        
        # Копируем ТЕКУЩИЕ файлы в корень (latest версия)
        cp -r ru/ en/ index.html _site/
        
        # Получаем список всех тегов
        echo "Available tags:"
        git tag -l
        
        # Создаем версии используя ТЕКУЩИЕ файлы
        echo "Creating version history..."
        git tag -l | while read tag; do
          if [[ "$tag" == v* ]]; then
            VERSION_NUMBER=${tag#v}
            echo "Creating version folder: v$VERSION_NUMBER"
            
            # Создаем папку для этой версии
            mkdir -p _site/v$VERSION_NUMBER
            
            # Копируем ТЕКУЩИЕ файлы в версионную папку
            cp -r ru/ en/ index.html _site/v$VERSION_NUMBER/
            
            echo "Version v$VERSION_NUMBER created with current files"
          fi
        done
        
        # Создаем страницу со списком ВСЕХ версий
        echo "<!DOCTYPE html>" > _site/versions.html
        echo "<html><head><title>All Website Versions</title><meta charset='UTF-8'><style>body{font-family:Arial;margin:40px}ul{list-style:none;padding:0}li{margin:15px 0}a{text-decoration:none;color:#0366d6;font-weight:bold}.version-list{background:#f5f5f5;padding:20px;border-radius:5px}</style></head><body>" >> _site/versions.html
        echo "<h1>Все доступные версии сайта</h1>" >> _site/versions.html
        echo "<div class='version-list'>" >> _site/versions.html
        echo "<ul>" >> _site/versions.html
        echo "<li><a href='/'>Последняя версия (актуальная)</a></li>" >> _site/versions.html
        git tag -l | while read tag; do
          if [[ "$tag" == v* ]]; then
            VERSION=${tag#v}
            echo "<li><a href='/v$VERSION/'>Версия $tag</a></li>" >> _site/versions.html
          fi
        done
        echo "</ul>" >> _site/versions.html
        echo "</div>" >> _site/versions.html
        echo "<p><em>Все версии содержат актуальную версию контента, но доступны по разным URL</em></p>" >> _site/versions.html
        echo "</body></html>" >> _site/versions.html
        
        # Показываем итоговую структуру
        echo "Final site structure:"
        find _site -type d | sort
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4