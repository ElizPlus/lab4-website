name: Deploy to GitHub Pages

on:
  push:
    tags: ['v*']
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Полная история для всех тегов
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Build site with ALL versions
      run: |
        # Создаем основную папку
        mkdir -p _site
        
        # Копируем файлы в корень (latest версия)
        cp -r ru/ en/ index.html _site/
        
        # СОЗДАЕМ ВСЕ ВЕРСИИ ИЗ ВСЕХ ТЕГОВ
        echo "Creating versions for all tags..."
        git tag -l | while read tag; do
          if [[ "$tag" == v* ]]; then
            VERSION_NUMBER=${tag#v}
            echo "Creating version: $VERSION_NUMBER from tag: $tag"
            
            # Переключаемся на этот тег
            git checkout $tag
            
            # Создаем папку для этой версии
            mkdir -p _site/v$VERSION_NUMBER
            
            # Копируем файлы из этой версии
            cp -r ru/ en/ index.html _site/v$VERSION_NUMBER/
            
            echo "Version $VERSION_NUMBER created"
          fi
        done
        
        # Возвращаемся к исходному состоянию
        git checkout ${{ github.ref }}
        
        # Создаем страницу со списком ВСЕХ версий
        echo "<!DOCTYPE html>" > _site/versions.html
        echo "<html><head><title>All Website Versions</title><style>body{font-family:Arial;margin:40px}ul{list-style:none;padding:0}li{margin:10px 0}a{text-decoration:none;color:#0366d6}</style></head><body>" >> _site/versions.html
        echo "<h1>All Available Website Versions</h1>" >> _site/versions.html
        echo "<ul>" >> _site/versions.html
        echo "<li><a href='/'>Latest Version (main)</a></li>" >> _site/versions.html
        git tag -l | while read tag; do
          if [[ "$tag" == v* ]]; then
            VERSION=${tag#v}
            echo "<li><a href='/v$VERSION/'>Version $tag</a></li>" >> _site/versions.html
          fi
        done
        echo "</ul>" >> _site/versions.html
        echo "</body></html>" >> _site/versions.html
        
        # Показываем итоговую структуру
        echo "Final site structure:"
        find _site -type d | sort
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4