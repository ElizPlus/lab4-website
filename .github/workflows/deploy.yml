name: Deploy to GitHub Pages

on:
  push:
    tags: ['v*']
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Полная история для тегов
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Build site with versions
      run: |
        # Создаем основную папку
        mkdir -p _site
        
        # Копируем файлы в корень (latest версия)
        cp -r ru/ en/ index.html _site/
        
        # Определяем версию тега
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          echo "Building versioned site: $RELEASE_TAG"
          
          # Убираем букву 'v' из имени папки
          VERSION_NUMBER=${RELEASE_TAG#v}  # Убираем 'v' из начала
          echo "Creating folder: v$VERSION_NUMBER"
          
          # Создаем папку для этой версии
          mkdir -p _site/v$VERSION_NUMBER
          
          # Копируем все файлы в версионную папку
          cp -r ru/ en/ index.html _site/v$VERSION_NUMBER/
          
          # Создаем страницу со списком версий
          echo "<!DOCTYPE html>" > _site/versions.html
          echo "<html><head><title>Available Versions</title></head><body>" >> _site/versions.html
          echo "<h1>Available Website Versions</h1>" >> _site/versions.html
          echo "<ul>" >> _site/versions.html
          echo "<li><a href='/'>Latest Version</a></li>" >> _site/versions.html
          git tag -l | while read tag; do
            VERSION=${tag#v}
            echo "<li><a href='/v$VERSION/'>Version $tag</a></li>" >> _site/versions.html
          done
          echo "</ul>" >> _site/versions.html
          echo "</body></html>" >> _site/versions.html
        else
          echo "Building latest version only"
        fi"Building latest version only"
        fi
        
        # Показываем что создали
        echo "Final site structure:"
        find _site -type f | sort
        echo "Files in _site/:"
        ls -la _site/
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4