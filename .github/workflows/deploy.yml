name: Deploy to GitHub Pages

on:
  push:
    tags: ['v*']
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è —Ç–µ–≥–æ–≤
      
    - name: Setup Pages
      uses: actions/configure-pages@v4
      
    - name: Build site with versions
      run: |
        # –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –ø–∞–ø–∫—É
        mkdir -p _site
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ –∫–æ—Ä–µ–Ω—å (latest –≤–µ—Ä—Å–∏—è)
        cp -r ru/ en/ index.html _site/
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤–µ—Ä—Å–∏—é —Ç–µ–≥–∞
        if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
          RELEASE_TAG=${GITHUB_REF#refs/tags/}
          echo "üöÄ Building versioned site: $RELEASE_TAG"
          
          # –£–±–∏—Ä–∞–µ–º –±—É–∫–≤—É 'v' –∏–∑ –∏–º–µ–Ω–∏ –ø–∞–ø–∫–∏
          VERSION_NUMBER=${RELEASE_TAG#v}  # –£–±–∏—Ä–∞–µ–º 'v' –∏–∑ –Ω–∞—á–∞–ª–∞
          echo "üìÅ Creating folder: v$VERSION_NUMBER"
          
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏
          mkdir -p _site/v$VERSION_NUMBER
          
          # –ö–æ–ø–∏—Ä—É–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –≤ –≤–µ—Ä—Å–∏–æ–Ω–Ω—É—é –ø–∞–ø–∫—É
          cp -r ru/ en/ index.html _site/v$VERSION_NUMBER/
          
          # –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å–æ —Å–ø–∏—Å–∫–æ–º –≤–µ—Ä—Å–∏–π
          echo "<!DOCTYPE html>" > _site/versions.html
          echo "<html><head><title>Available Versions</title></head><body>" >> _site/versions.html
          echo "<h1>üåê Available Website Versions</h1>" >> _site/versions.html
          echo "<ul>" >> _site/versions.html
          echo "<li><a href='/'>Latest Version</a></li>" >> _site/versions.html
          git tag -l | while read tag; do
            VERSION=${tag#v}
            echo "<li><a href='/v$VERSION/'>Version $tag</a></li>" >> _site/versions.html
          done
          echo "</ul>" >> _site/versions.html
          echo "</body></html>" >> _site/versions.html
        else
          echo "üì¶ Building latest version only"
        fi"Building latest version only"
        fi
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏
        echo "Final site structure:"
        find _site -type f | sort
        echo "Files in _site/:"
        ls -la _site/
        
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: _site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4